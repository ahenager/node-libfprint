#!/usr/bin/env node
/// <reference path="../typings/tsd.d.ts"/>
var binary = require('node-pre-gyp');
var path = require('path');
var PACKAGE_JSON = path.join(__dirname, '../package.json');
var binding_path = binary.find(path.resolve(PACKAGE_JSON));
var fprintbinding = require(binding_path);

var stream = require('stream');
var util = require('util');
var bunyan = require('bunyan');
var events = require('events');

var log;

(function (fp_enroll_result) {
    fp_enroll_result[fp_enroll_result["ENROLL_COMPLETE"] = 1] = "ENROLL_COMPLETE";
    fp_enroll_result[fp_enroll_result["ENROLL_FAIL"] = 2] = "ENROLL_FAIL";
    fp_enroll_result[fp_enroll_result["ENROLL_PASS"] = 3] = "ENROLL_PASS";
    fp_enroll_result[fp_enroll_result["ENROLL_RETRY"] = 100] = "ENROLL_RETRY";
    fp_enroll_result[fp_enroll_result["ENROLL_RETRY_TOO_SHORT"] = 101] = "ENROLL_RETRY_TOO_SHORT";
    fp_enroll_result[fp_enroll_result["ENROLL_RETRY_CENTER_FINGER"] = 102] = "ENROLL_RETRY_CENTER_FINGER";
    fp_enroll_result[fp_enroll_result["ENROLL_RETRY_REMOVE_FINGER"] = 103] = "ENROLL_RETRY_REMOVE_FINGER";
})(exports.fp_enroll_result || (exports.fp_enroll_result = {}));
var fp_enroll_result = exports.fp_enroll_result;

var fpreader = (function () {
    function fpreader(fpinstance) {
        var _this = this;
        this.close = function () {
            _this.wrapped.close();
        };
        // Start enrolling a fingerprint
        this.start_enroll = function (callback) {
            // tell the fpreader to begin the enroll finger process
            if (!_this.wrapped.enroll_finger(function (result, fpdata, fpimage, height, width) {
                var err = null;

                // If the result was not a successful enrollment
                if (result != 1 /* ENROLL_COMPLETE */) {
                    // store error code in err
                    err = fp_enroll_result[result];
                }

                // check the fpdata for completeness
                if (fpdata !== null && fpdata !== undefined) {
                    var data = new Buffer(fpdata.length);
                    fpdata.copy(data);
                }

                // shouldn't we check these as well? TODO
                var image = new Buffer(fpimage.length);
                fpimage.copy(image);

                // callback to fp_server
                callback(err, result, data, image, height, width);
            })) {
                // Not finished yet!
                callback("Enroll in progress!", null, null, null, null, null);
            }
        };
        // Stop enrolling a fingerprint
        this.stop_enroll = function (callback) {
            // tell the fp.reader to stop enrollment (if it is enrolling)
            _this.wrapped.stop_enroll_finger();
            callback();
        };
        // Start identifying a fingerprint
        this.start_identify = function (callback) {
            // TODO
            callback(null, null);
        };
        // Stop identifying a fingerprint
        this.stop_identify = function (callback) {
            // tell the fp.reader to stop identifying (if it is identifying)
            _this.wrapped.stop_identify_finger();
            callback();
        };
        this.wrapped = fpinstance;

        //these values are static so we can grab them now
        this.enroll_stages = fpinstance.enroll_stages;
        this.supports_imaging = fpinstance.supports_imaging;
        this.supports_identification = fpinstance.supports_identification;
        this.img_width = fpinstance.img_width;
        this.img_height = fpinstance.img_height;
    }
    return fpreader;
})();
exports.fpreader = fpreader;

var fprint = (function () {
    function fprint() {
    }
    // Initializes libfprint and returns 0 if successful.
    fprint.prototype.init = function () {
        return fprintbinding.init();
    };

    fprint.prototype.discover = function () {
        var devices = [];
        fprintbinding.discover(function (handle, devid, drvtype, drvname, drvfullname) {
            var thisdev = {
                handle: handle,
                deviceid: devid,
                driver_type: drvtype,
                driver: drvname,
                driver_detail: drvfullname
            };

            devices.push(thisdev);
        });

        return devices;
    };

    fprint.prototype.get_reader = function (handle) {
        var reader = new fprintbinding.fpreader(handle);
        if (typeof reader != 'undefined') {
            return new fpreader(reader);
        }
        return null;
    };

    fprint.prototype.exit = function () {
        return fprintbinding.exit();
    };
    return fprint;
})();
exports.fprint = fprint;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYmZwcmludC50cyJdLCJuYW1lcyI6WyJmcF9lbnJvbGxfcmVzdWx0IiwiZnByZWFkZXIiLCJmcHJlYWRlci5jb25zdHJ1Y3RvciIsImZwcmludCIsImZwcmludC5jb25zdHJ1Y3RvciIsImZwcmludC5pbml0IiwiZnByaW50LmRpc2NvdmVyIiwiZnByaW50LmdldF9yZWFkZXIiLCJmcHJpbnQuZXhpdCJdLCJtYXBwaW5ncyI6IkFBQUEsMkNBQTJDO0FBQTNDLElBRUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxjQUFjLENBQUM7QUFDcEMsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQztBQUMxQixJQUFJLFlBQVksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxpQkFBaUIsQ0FBQztBQUMxRCxJQUFJLFlBQVksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDMUQsSUFBSSxhQUFhLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQzs7QUFFekMsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQztBQUM5QixJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO0FBQzFCLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUM7QUFDOUIsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQzs7QUFFOUIsSUFBSSxHQUFHOztDQUVQLFVBQVksZ0JBQWdCO0lBRXhCQSx1REFBa0JBLENBQUNBLHFCQUFBQTtJQUNuQkEsbURBQWNBLENBQUNBLGlCQUFBQTtJQUNmQSxtREFBY0EsQ0FBQ0EsaUJBQUFBO0lBQ2ZBLG9EQUFlQSxHQUFHQSxrQkFBQUE7SUFDbEJBLDhEQUF5QkEsR0FBR0EsNEJBQUFBO0lBQzVCQSxrRUFBNkJBLEdBQUdBLGdDQUFBQTtJQUNoQ0Esa0VBQTZCQSxHQUFHQSxnQ0FBQUE7Z0VBQ25DO2dEQUFBOztBQUVEO0lBc0VJ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aWJmcHJpbnQuanMiLCJzb3VyY2VSb290IjoiL2hvbWUvYWVyby9ub2RlLWxpYmZwcmludC8iLCJzb3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vdHlwaW5ncy90c2QuZC50c1wiLz5cblxudmFyIGJpbmFyeSA9IHJlcXVpcmUoJ25vZGUtcHJlLWd5cCcpO1xudmFyIHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG52YXIgUEFDS0FHRV9KU09OID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL3BhY2thZ2UuanNvbicpO1xudmFyIGJpbmRpbmdfcGF0aCA9IGJpbmFyeS5maW5kKHBhdGgucmVzb2x2ZShQQUNLQUdFX0pTT04pKTtcbnZhciBmcHJpbnRiaW5kaW5nID0gcmVxdWlyZShiaW5kaW5nX3BhdGgpO1xuXG52YXIgc3RyZWFtID0gcmVxdWlyZSgnc3RyZWFtJyk7XG52YXIgdXRpbCA9IHJlcXVpcmUoJ3V0aWwnKTtcbnZhciBidW55YW4gPSByZXF1aXJlKCdidW55YW4nKTtcbnZhciBldmVudHMgPSByZXF1aXJlKCdldmVudHMnKTtcblxudmFyIGxvZztcblxuZXhwb3J0IGVudW0gZnBfZW5yb2xsX3Jlc3VsdFxue1xuICAgIEVOUk9MTF9DT01QTEVURSA9IDEsXG4gICAgRU5ST0xMX0ZBSUwgPSAyLFxuICAgIEVOUk9MTF9QQVNTID0gMyxcbiAgICBFTlJPTExfUkVUUlkgPSAxMDAsXG4gICAgRU5ST0xMX1JFVFJZX1RPT19TSE9SVCA9IDEwMSxcbiAgICBFTlJPTExfUkVUUllfQ0VOVEVSX0ZJTkdFUiA9IDEwMixcbiAgICBFTlJPTExfUkVUUllfUkVNT1ZFX0ZJTkdFUiA9IDEwM1xufVxuXG5leHBvcnQgY2xhc3MgZnByZWFkZXIge1xuICAgIHByaXZhdGUgd3JhcHBlZDtcblxuICAgIGVucm9sbF9zdGFnZXMgOiBudW1iZXI7XG4gICAgc3VwcG9ydHNfaW1hZ2luZyA6IGJvb2xlYW47XG4gICAgc3VwcG9ydHNfaWRlbnRpZmljYXRpb246IGJvb2xlYW47XG4gICAgaW1nX3dpZHRoOiBudW1iZXI7XG4gICAgaW1nX2hlaWdodDogbnVtYmVyO1xuXG4gICAgY2xvc2UgPSAoKSA9PiB7XG4gICAgICAgIHRoaXMud3JhcHBlZC5jbG9zZSgpO1xuICAgIH1cblxuICAgIC8vIFN0YXJ0IGVucm9sbGluZyBhIGZpbmdlcnByaW50XG4gICAgc3RhcnRfZW5yb2xsID0gKGNhbGxiYWNrIDogKGVyciwgcmVzdWx0IDogZnBfZW5yb2xsX3Jlc3VsdCwgZnBkYXRhIDogQnVmZmVyLCBmcGltYWdlOiBCdWZmZXIsIGhlaWdodCA6IE51bWJlciwgd2lkdGggOiBOdW1iZXIpID0+IHZvaWQpIDogdm9pZCA9PiB7XG4gICAgXG4gICAgICAgIC8vIHRlbGwgdGhlIGZwcmVhZGVyIHRvIGJlZ2luIHRoZSBlbnJvbGwgZmluZ2VyIHByb2Nlc3NcbiAgICAgICAgaWYgKCF0aGlzLndyYXBwZWQuZW5yb2xsX2ZpbmdlcihcbiAgICAgICAgICAgICAgICAvLyBFbnJvbGwgZmluZ2VyIGhhcyBjb21wbGV0ZWRcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiAocmVzdWx0OiBmcF9lbnJvbGxfcmVzdWx0LCBmcGRhdGEsIGZwaW1hZ2UsIGhlaWdodCA6IG51bWJlciwgd2lkdGg6IG51bWJlcilcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBlcnIgPSBudWxsO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vIElmIHRoZSByZXN1bHQgd2FzIG5vdCBhIHN1Y2Nlc3NmdWwgZW5yb2xsbWVudFxuICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0ICE9IGZwX2Vucm9sbF9yZXN1bHQuRU5ST0xMX0NPTVBMRVRFKVxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBzdG9yZSBlcnJvciBjb2RlIGluIGVyclxuICAgICAgICAgICAgICAgICAgICAgICAgZXJyID0gZnBfZW5yb2xsX3Jlc3VsdFtyZXN1bHRdO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gY2hlY2sgdGhlIGZwZGF0YSBmb3IgY29tcGxldGVuZXNzXG4gICAgICAgICAgICAgICAgICAgIGlmIChmcGRhdGEgIT09IG51bGwgJiYgZnBkYXRhICE9PSB1bmRlZmluZWQpXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkYXRhID0gbmV3IEJ1ZmZlcihmcGRhdGEubGVuZ3RoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZwZGF0YS5jb3B5KGRhdGEpO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gc2hvdWxkbid0IHdlIGNoZWNrIHRoZXNlIGFzIHdlbGw/IFRPRE9cbiAgICAgICAgICAgICAgICAgICAgdmFyIGltYWdlID0gbmV3IEJ1ZmZlcihmcGltYWdlLmxlbmd0aCk7XG4gICAgICAgICAgICAgICAgICAgIGZwaW1hZ2UuY29weShpbWFnZSk7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gY2FsbGJhY2sgdG8gZnBfc2VydmVyXG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVyciwgcmVzdWx0LCBkYXRhLCBpbWFnZSwgaGVpZ2h0LCB3aWR0aCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICApKSB7XG4gICAgICAgICAgICAvLyBOb3QgZmluaXNoZWQgeWV0IVxuICAgICAgICAgICAgY2FsbGJhY2soXCJFbnJvbGwgaW4gcHJvZ3Jlc3MhXCIsIG51bGwsIG51bGwsIG51bGwsIG51bGwsIG51bGwpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gU3RvcCBlbnJvbGxpbmcgYSBmaW5nZXJwcmludFxuICAgIHN0b3BfZW5yb2xsID0gKGNhbGxiYWNrIDogKCkgPT4gdm9pZCkgOiB2b2lkID0+IHtcbiAgICAgICAgLy8gdGVsbCB0aGUgZnAucmVhZGVyIHRvIHN0b3AgZW5yb2xsbWVudCAoaWYgaXQgaXMgZW5yb2xsaW5nKVxuICAgICAgICB0aGlzLndyYXBwZWQuc3RvcF9lbnJvbGxfZmluZ2VyKCk7XG4gICAgICAgIGNhbGxiYWNrKCk7XG4gICAgfVxuXG4gICAgLy8gU3RhcnQgaWRlbnRpZnlpbmcgYSBmaW5nZXJwcmludFxuICAgIHN0YXJ0X2lkZW50aWZ5ID0gKGNhbGxiYWNrIDogKGVyciwgc3VjY2VzcykgPT4gdm9pZCkgOiB2b2lkID0+IHtcbiAgICAgICAgLy8gVE9ET1xuICAgICAgICBjYWxsYmFjayhudWxsLG51bGwpO1xuICAgIH1cblxuICAgIC8vIFN0b3AgaWRlbnRpZnlpbmcgYSBmaW5nZXJwcmludFxuICAgIHN0b3BfaWRlbnRpZnkgPSAoY2FsbGJhY2sgOiAoKSA9PiB2b2lkKSA6IHZvaWQgPT4ge1xuICAgICAgICAvLyB0ZWxsIHRoZSBmcC5yZWFkZXIgdG8gc3RvcCBpZGVudGlmeWluZyAoaWYgaXQgaXMgaWRlbnRpZnlpbmcpXG4gICAgICAgIHRoaXMud3JhcHBlZC5zdG9wX2lkZW50aWZ5X2ZpbmdlcigpO1xuICAgICAgICBjYWxsYmFjaygpO1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKGZwaW5zdGFuY2UpIHtcbiAgICAgICAgdGhpcy53cmFwcGVkID0gZnBpbnN0YW5jZTtcblxuICAgICAgICAvL3RoZXNlIHZhbHVlcyBhcmUgc3RhdGljIHNvIHdlIGNhbiBncmFiIHRoZW0gbm93XG4gICAgICAgIHRoaXMuZW5yb2xsX3N0YWdlcyA9IGZwaW5zdGFuY2UuZW5yb2xsX3N0YWdlcztcbiAgICAgICAgdGhpcy5zdXBwb3J0c19pbWFnaW5nID0gZnBpbnN0YW5jZS5zdXBwb3J0c19pbWFnaW5nO1xuICAgICAgICB0aGlzLnN1cHBvcnRzX2lkZW50aWZpY2F0aW9uID0gZnBpbnN0YW5jZS5zdXBwb3J0c19pZGVudGlmaWNhdGlvbjtcbiAgICAgICAgdGhpcy5pbWdfd2lkdGggPSBmcGluc3RhbmNlLmltZ193aWR0aDtcbiAgICAgICAgdGhpcy5pbWdfaGVpZ2h0ID0gZnBpbnN0YW5jZS5pbWdfaGVpZ2h0O1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIGZwcmludCB7XG5cbiAgICAvLyBJbml0aWFsaXplcyBsaWJmcHJpbnQgYW5kIHJldHVybnMgMCBpZiBzdWNjZXNzZnVsLlxuICAgIGluaXQoKSA6IG51bWJlciAge1xuICAgICAgICByZXR1cm4gZnByaW50YmluZGluZy5pbml0KCk7XG4gICAgfVxuXG4gICAgZGlzY292ZXIoKSB7XG4gICAgICAgIHZhciBkZXZpY2VzID0gW107XG4gICAgICAgIGZwcmludGJpbmRpbmcuZGlzY292ZXIoIGZ1bmN0aW9uKGhhbmRsZSwgZGV2aWQsIGRydnR5cGUsIGRydm5hbWUsIGRydmZ1bGxuYW1lKVxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRoaXNkZXYgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGU6IGhhbmRsZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRldmljZWlkOiBkZXZpZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRyaXZlcl90eXBlOiBkcnZ0eXBlLFxuICAgICAgICAgICAgICAgICAgICAgICAgZHJpdmVyOiBkcnZuYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgZHJpdmVyX2RldGFpbDogZHJ2ZnVsbG5hbWVcbiAgICAgICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgICAgICBkZXZpY2VzLnB1c2godGhpc2Rldik7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGRldmljZXM7XG4gICAgfVxuXG4gICAgZ2V0X3JlYWRlcihoYW5kbGU6IG51bWJlcikge1xuICAgICAgICB2YXIgcmVhZGVyID0gbmV3IGZwcmludGJpbmRpbmcuZnByZWFkZXIoaGFuZGxlKTtcbiAgICAgICAgaWYgKHR5cGVvZiByZWFkZXIgIT0gJ3VuZGVmaW5lZCcpXG4gICAgICAgIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgZnByZWFkZXIocmVhZGVyKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBleGl0KCkgOiB2b2lkIHtcbiAgICAgICAgcmV0dXJuIGZwcmludGJpbmRpbmcuZXhpdCgpO1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yICgpIHsgfVxufVxuIl19