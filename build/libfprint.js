#!/usr/bin/env node
/// <reference path="../typings/tsd.d.ts"/>
var binary = require('node-pre-gyp');
var path = require('path');
var PACKAGE_JSON = path.join(__dirname, '../package.json');
var binding_path = binary.find(path.resolve(PACKAGE_JSON));
var fprintbinding = require(binding_path);
var stream = require('stream');
var util = require('util');
var bunyan = require('bunyan');
var events = require('events');
var log;
(function (fp_enroll_result) {
    fp_enroll_result[fp_enroll_result["ENROLL_COMPLETE"] = 1] = "ENROLL_COMPLETE";
    fp_enroll_result[fp_enroll_result["ENROLL_FAIL"] = 2] = "ENROLL_FAIL";
    fp_enroll_result[fp_enroll_result["ENROLL_PASS"] = 3] = "ENROLL_PASS";
    fp_enroll_result[fp_enroll_result["ENROLL_RETRY"] = 100] = "ENROLL_RETRY";
    fp_enroll_result[fp_enroll_result["ENROLL_RETRY_TOO_SHORT"] = 101] = "ENROLL_RETRY_TOO_SHORT";
    fp_enroll_result[fp_enroll_result["ENROLL_RETRY_CENTER_FINGER"] = 102] = "ENROLL_RETRY_CENTER_FINGER";
    fp_enroll_result[fp_enroll_result["ENROLL_RETRY_REMOVE_FINGER"] = 103] = "ENROLL_RETRY_REMOVE_FINGER";
})(exports.fp_enroll_result || (exports.fp_enroll_result = {}));
var fp_enroll_result = exports.fp_enroll_result;
var fpreader = (function () {
    function fpreader(fpinstance) {
        var _this = this;
        this.close = function () {
            _this.wrapped.close();
        };
        // Start enrolling a fingerprint
        this.start_enroll = function (callback) {
            // tell the fpreader to begin the enroll finger process
            if (!_this.wrapped.enroll_finger(
            // Enroll finger has completed
            function (result, fpdata, fpimage, height, width) {
                var err = null;
                // If the result was not a successful enrollment
                if (result != 1 /* ENROLL_COMPLETE */) {
                    // store error code in err
                    err = fp_enroll_result[result];
                }
                // check the fpdata for completeness
                if (fpdata !== null && fpdata !== undefined) {
                    var data = new Buffer(fpdata.length);
                    fpdata.copy(data);
                }
                // shouldn't we check these as well? TODO
                var image = new Buffer(fpimage.length);
                fpimage.copy(image);
                // callback to fp_server
                callback(err, result, data, image, height, width);
            })) {
                // Not finished yet!
                callback("Enroll in progress!", null, null, null, null, null);
            }
        };
        // Stop enrolling a fingerprint
        this.stop_enroll = function () {
            // tell the fp.reader to stop enrollment (if it is enrolling)
            _this.wrapped.stop_enroll_finger();
        };
        // Start identifying a fingerprint
        this.start_identify = function (callback) {
            // TODO
            callback(null, null);
        };
        // Stop identifying a fingerprint
        this.stop_identify = function () {
            _this.wrapped.stop_identify_finger();
        };
        this.wrapped = fpinstance;
        //these values are static so we can grab them now
        this.enroll_stages = fpinstance.enroll_stages;
        this.supports_imaging = fpinstance.supports_imaging;
        this.supports_identification = fpinstance.supports_identification;
        this.img_width = fpinstance.img_width;
        this.img_height = fpinstance.img_height;
    }
    return fpreader;
})();
exports.fpreader = fpreader;
var fprint = (function () {
    function fprint() {
    }
    // Initializes libfprint and returns 0 if successful.
    fprint.prototype.init = function () {
        return fprintbinding.init();
    };
    fprint.prototype.discover = function () {
        var devices = [];
        fprintbinding.discover(function (handle, devid, drvtype, drvname, drvfullname) {
            var thisdev = {
                handle: handle,
                deviceid: devid,
                driver_type: drvtype,
                driver: drvname,
                driver_detail: drvfullname
            };
            devices.push(thisdev);
        });
        return devices;
    };
    fprint.prototype.get_reader = function (handle) {
        var reader = new fprintbinding.fpreader(handle);
        if (typeof reader != 'undefined') {
            return new fpreader(reader);
        }
        return null;
    };
    fprint.prototype.exit = function () {
        return fprintbinding.exit();
    };
    return fprint;
})();
exports.fprint = fprint;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYmZwcmludC50cyJdLCJuYW1lcyI6WyJmcF9lbnJvbGxfcmVzdWx0IiwiZnByZWFkZXIiLCJmcHJlYWRlci5jb25zdHJ1Y3RvciIsImZwcmludCIsImZwcmludC5jb25zdHJ1Y3RvciIsImZwcmludC5pbml0IiwiZnByaW50LmRpc2NvdmVyIiwiZnByaW50LmdldF9yZWFkZXIiLCJmcHJpbnQuZXhpdCJdLCJtYXBwaW5ncyI6IkFBQUEsMkNBQTJDO0FBRTNDLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUNyQyxJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDM0IsSUFBSSxZQUFZLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztBQUMzRCxJQUFJLFlBQVksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztBQUMzRCxJQUFJLGFBQWEsR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7QUFFMUMsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQy9CLElBQUksSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUMzQixJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDL0IsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBRS9CLElBQUksR0FBRyxDQUFDO0FBRVIsV0FBWSxnQkFBZ0I7SUFFeEJBLHVEQUFrQkEsQ0FBQ0EscUJBQUFBO0lBQ25CQSxtREFBY0EsQ0FBQ0EsaUJBQUFBO0lBQ2ZBLG1EQUFjQSxDQUFDQSxpQkFBQUE7SUFDZkEsb0RBQWVBLEdBQUdBLGtCQUFBQTtJQUNsQkEsOERBQXlCQSxHQUFHQSw0QkFBQUE7SUFDNUJBLGtFQUE2QkEsR0FBR0EsZ0NBQUFBO0lBQ2hD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QSxPQUFPQSxNQUFNQSxJQUFJQSxXQUFXQSxDQUFDQSxDQUNqQ0EsQ0FBQ0E7WUFDR0EsTUFBTUEsQ0FBQ0EsSUFBSUEsUUFBUUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7UUFDaENBLENBQUNBO1FBQ0RBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBO0lBQ2hCQSxDQUFDQTtJQUVESixxQkFBSUEsR0FBSkE7UUFDSUssTUFBTUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsSUFBSUEsRUFBRUEsQ0FBQ0E7SUFDaENBLENBQUNBO0lBR0xMLGFBQUNBO0FBQURBLENBdkNBLEFBdUNDQSxJQUFBO0FBdkNZLGNBQU0sR0FBTixNQXVDWixDQUFBIiwiZmlsZSI6ImxpYmZwcmludC5qcyIsInNvdXJjZVJvb3QiOiIvaG9tZS9hZXJvL25vZGUtbGliZnByaW50LyIsInNvdXJjZXNDb250ZW50IjpbIi8vLyA8cmVmZXJlbmNlIHBhdGg9XCIuLi90eXBpbmdzL3RzZC5kLnRzXCIvPlxuXG52YXIgYmluYXJ5ID0gcmVxdWlyZSgnbm9kZS1wcmUtZ3lwJyk7XG52YXIgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbnZhciBQQUNLQUdFX0pTT04gPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vcGFja2FnZS5qc29uJyk7XG52YXIgYmluZGluZ19wYXRoID0gYmluYXJ5LmZpbmQocGF0aC5yZXNvbHZlKFBBQ0tBR0VfSlNPTikpO1xudmFyIGZwcmludGJpbmRpbmcgPSByZXF1aXJlKGJpbmRpbmdfcGF0aCk7XG5cbnZhciBzdHJlYW0gPSByZXF1aXJlKCdzdHJlYW0nKTtcbnZhciB1dGlsID0gcmVxdWlyZSgndXRpbCcpO1xudmFyIGJ1bnlhbiA9IHJlcXVpcmUoJ2J1bnlhbicpO1xudmFyIGV2ZW50cyA9IHJlcXVpcmUoJ2V2ZW50cycpO1xuXG52YXIgbG9nO1xuXG5leHBvcnQgZW51bSBmcF9lbnJvbGxfcmVzdWx0XG57XG4gICAgRU5ST0xMX0NPTVBMRVRFID0gMSxcbiAgICBFTlJPTExfRkFJTCA9IDIsXG4gICAgRU5ST0xMX1BBU1MgPSAzLFxuICAgIEVOUk9MTF9SRVRSWSA9IDEwMCxcbiAgICBFTlJPTExfUkVUUllfVE9PX1NIT1JUID0gMTAxLFxuICAgIEVOUk9MTF9SRVRSWV9DRU5URVJfRklOR0VSID0gMTAyLFxuICAgIEVOUk9MTF9SRVRSWV9SRU1PVkVfRklOR0VSID0gMTAzXG59XG5cbmV4cG9ydCBjbGFzcyBmcHJlYWRlciB7XG4gICAgcHJpdmF0ZSB3cmFwcGVkO1xuXG4gICAgZW5yb2xsX3N0YWdlcyA6IG51bWJlcjtcbiAgICBzdXBwb3J0c19pbWFnaW5nIDogYm9vbGVhbjtcbiAgICBzdXBwb3J0c19pZGVudGlmaWNhdGlvbjogYm9vbGVhbjtcbiAgICBpbWdfd2lkdGg6IG51bWJlcjtcbiAgICBpbWdfaGVpZ2h0OiBudW1iZXI7XG5cbiAgICBjbG9zZSA9ICgpID0+IHtcbiAgICAgICAgdGhpcy53cmFwcGVkLmNsb3NlKCk7XG4gICAgfVxuXG4gICAgLy8gU3RhcnQgZW5yb2xsaW5nIGEgZmluZ2VycHJpbnRcbiAgICBzdGFydF9lbnJvbGwgPSAoY2FsbGJhY2sgOiAoZXJyLCByZXN1bHQgOiBmcF9lbnJvbGxfcmVzdWx0LCBmcGRhdGEgOiBCdWZmZXIsIGZwaW1hZ2U6IEJ1ZmZlciwgaGVpZ2h0IDogTnVtYmVyLCB3aWR0aCA6IE51bWJlcikgPT4gdm9pZCkgOiB2b2lkID0+IHtcbiAgICBcbiAgICAgICAgLy8gdGVsbCB0aGUgZnByZWFkZXIgdG8gYmVnaW4gdGhlIGVucm9sbCBmaW5nZXIgcHJvY2Vzc1xuICAgICAgICBpZiAoIXRoaXMud3JhcHBlZC5lbnJvbGxfZmluZ2VyKFxuICAgICAgICAgICAgICAgIC8vIEVucm9sbCBmaW5nZXIgaGFzIGNvbXBsZXRlZFxuICAgICAgICAgICAgICAgIGZ1bmN0aW9uIChyZXN1bHQ6IGZwX2Vucm9sbF9yZXN1bHQsIGZwZGF0YSwgZnBpbWFnZSwgaGVpZ2h0IDogbnVtYmVyLCB3aWR0aDogbnVtYmVyKVxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGVyciA9IG51bGw7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlIHJlc3VsdCB3YXMgbm90IGEgc3VjY2Vzc2Z1bCBlbnJvbGxtZW50XG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXN1bHQgIT0gZnBfZW5yb2xsX3Jlc3VsdC5FTlJPTExfQ09NUExFVEUpXG4gICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHN0b3JlIGVycm9yIGNvZGUgaW4gZXJyXG4gICAgICAgICAgICAgICAgICAgICAgICBlcnIgPSBmcF9lbnJvbGxfcmVzdWx0W3Jlc3VsdF07XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAvLyBjaGVjayB0aGUgZnBkYXRhIGZvciBjb21wbGV0ZW5lc3NcbiAgICAgICAgICAgICAgICAgICAgaWYgKGZwZGF0YSAhPT0gbnVsbCAmJiBmcGRhdGEgIT09IHVuZGVmaW5lZClcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRhdGEgPSBuZXcgQnVmZmVyKGZwZGF0YS5sZW5ndGgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZnBkYXRhLmNvcHkoZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAvLyBzaG91bGRuJ3Qgd2UgY2hlY2sgdGhlc2UgYXMgd2VsbD8gVE9ET1xuICAgICAgICAgICAgICAgICAgICB2YXIgaW1hZ2UgPSBuZXcgQnVmZmVyKGZwaW1hZ2UubGVuZ3RoKTtcbiAgICAgICAgICAgICAgICAgICAgZnBpbWFnZS5jb3B5KGltYWdlKTtcblxuICAgICAgICAgICAgICAgICAgICAvLyBjYWxsYmFjayB0byBmcF9zZXJ2ZXJcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZXJyLCByZXN1bHQsIGRhdGEsIGltYWdlLCBoZWlnaHQsIHdpZHRoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICkpIHtcbiAgICAgICAgICAgIC8vIE5vdCBmaW5pc2hlZCB5ZXQhXG4gICAgICAgICAgICBjYWxsYmFjayhcIkVucm9sbCBpbiBwcm9ncmVzcyFcIiwgbnVsbCwgbnVsbCwgbnVsbCwgbnVsbCwgbnVsbCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBTdG9wIGVucm9sbGluZyBhIGZpbmdlcnByaW50XG4gICAgc3RvcF9lbnJvbGwgPSAoKSA6IHZvaWQgPT4ge1xuICAgICAgICAvLyB0ZWxsIHRoZSBmcC5yZWFkZXIgdG8gc3RvcCBlbnJvbGxtZW50IChpZiBpdCBpcyBlbnJvbGxpbmcpXG4gICAgICAgIHRoaXMud3JhcHBlZC5zdG9wX2Vucm9sbF9maW5nZXIoKTtcbiAgICB9XG5cbiAgICAvLyBTdGFydCBpZGVudGlmeWluZyBhIGZpbmdlcnByaW50XG4gICAgc3RhcnRfaWRlbnRpZnkgPSAoY2FsbGJhY2sgOiAoZXJyLCBzdWNjZXNzKSA9PiB2b2lkKSA6IHZvaWQgPT4ge1xuICAgICAgICAvLyBUT0RPXG4gICAgICAgIGNhbGxiYWNrKG51bGwsbnVsbCk7XG4gICAgfVxuXG4gICAgLy8gU3RvcCBpZGVudGlmeWluZyBhIGZpbmdlcnByaW50XG4gICAgc3RvcF9pZGVudGlmeSA9ICgpIDogdm9pZCA9PiB7XG4gICAgICAgIHRoaXMud3JhcHBlZC5zdG9wX2lkZW50aWZ5X2ZpbmdlcigpO1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKGZwaW5zdGFuY2UpIHtcbiAgICAgICAgdGhpcy53cmFwcGVkID0gZnBpbnN0YW5jZTtcblxuICAgICAgICAvL3RoZXNlIHZhbHVlcyBhcmUgc3RhdGljIHNvIHdlIGNhbiBncmFiIHRoZW0gbm93XG4gICAgICAgIHRoaXMuZW5yb2xsX3N0YWdlcyA9IGZwaW5zdGFuY2UuZW5yb2xsX3N0YWdlcztcbiAgICAgICAgdGhpcy5zdXBwb3J0c19pbWFnaW5nID0gZnBpbnN0YW5jZS5zdXBwb3J0c19pbWFnaW5nO1xuICAgICAgICB0aGlzLnN1cHBvcnRzX2lkZW50aWZpY2F0aW9uID0gZnBpbnN0YW5jZS5zdXBwb3J0c19pZGVudGlmaWNhdGlvbjtcbiAgICAgICAgdGhpcy5pbWdfd2lkdGggPSBmcGluc3RhbmNlLmltZ193aWR0aDtcbiAgICAgICAgdGhpcy5pbWdfaGVpZ2h0ID0gZnBpbnN0YW5jZS5pbWdfaGVpZ2h0O1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIGZwcmludCB7XG5cbiAgICAvLyBJbml0aWFsaXplcyBsaWJmcHJpbnQgYW5kIHJldHVybnMgMCBpZiBzdWNjZXNzZnVsLlxuICAgIGluaXQoKSA6IG51bWJlciAge1xuICAgICAgICByZXR1cm4gZnByaW50YmluZGluZy5pbml0KCk7XG4gICAgfVxuXG4gICAgZGlzY292ZXIoKSB7XG4gICAgICAgIHZhciBkZXZpY2VzID0gW107XG4gICAgICAgIGZwcmludGJpbmRpbmcuZGlzY292ZXIoIGZ1bmN0aW9uKGhhbmRsZSwgZGV2aWQsIGRydnR5cGUsIGRydm5hbWUsIGRydmZ1bGxuYW1lKVxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRoaXNkZXYgPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGU6IGhhbmRsZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRldmljZWlkOiBkZXZpZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIGRyaXZlcl90eXBlOiBkcnZ0eXBlLFxuICAgICAgICAgICAgICAgICAgICAgICAgZHJpdmVyOiBkcnZuYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgZHJpdmVyX2RldGFpbDogZHJ2ZnVsbG5hbWVcbiAgICAgICAgICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgICAgICAgICBkZXZpY2VzLnB1c2godGhpc2Rldik7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGRldmljZXM7XG4gICAgfVxuXG4gICAgZ2V0X3JlYWRlcihoYW5kbGU6IG51bWJlcikge1xuICAgICAgICB2YXIgcmVhZGVyID0gbmV3IGZwcmludGJpbmRpbmcuZnByZWFkZXIoaGFuZGxlKTtcbiAgICAgICAgaWYgKHR5cGVvZiByZWFkZXIgIT0gJ3VuZGVmaW5lZCcpXG4gICAgICAgIHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgZnByZWFkZXIocmVhZGVyKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBleGl0KCkgOiB2b2lkIHtcbiAgICAgICAgcmV0dXJuIGZwcmludGJpbmRpbmcuZXhpdCgpO1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yICgpIHsgfVxufVxuIl19