#!/usr/bin/env node
/// <reference path="../typings/tsd.d.ts"/>
var binary = require('node-pre-gyp');
var path = require('path');
var PACKAGE_JSON = path.join(__dirname, '../package.json');
var binding_path = binary.find(path.resolve(PACKAGE_JSON));
var fprintbinding = require(binding_path);

var stream = require('stream');
var util = require('util');
var bunyan = require('bunyan');
var events = require('events');

var log;

(function (fp_enroll_result) {
    fp_enroll_result[fp_enroll_result["ENROLL_COMPLETE"] = 1] = "ENROLL_COMPLETE";
    fp_enroll_result[fp_enroll_result["ENROLL_FAIL"] = 2] = "ENROLL_FAIL";
    fp_enroll_result[fp_enroll_result["ENROLL_PASS"] = 3] = "ENROLL_PASS";
    fp_enroll_result[fp_enroll_result["ENROLL_RETRY"] = 100] = "ENROLL_RETRY";
    fp_enroll_result[fp_enroll_result["ENROLL_RETRY_TOO_SHORT"] = 101] = "ENROLL_RETRY_TOO_SHORT";
    fp_enroll_result[fp_enroll_result["ENROLL_RETRY_CENTER_FINGER"] = 102] = "ENROLL_RETRY_CENTER_FINGER";
    fp_enroll_result[fp_enroll_result["ENROLL_RETRY_REMOVE_FINGER"] = 103] = "ENROLL_RETRY_REMOVE_FINGER";
    fp_enroll_result[fp_enroll_result["ENROLL_CANCELLED"] = 200] = "ENROLL_CANCELLED";
})(exports.fp_enroll_result || (exports.fp_enroll_result = {}));
var fp_enroll_result = exports.fp_enroll_result;

(function (fp_stop_result) {
    fp_stop_result[fp_stop_result["STOP_SUCCESS"] = 1] = "STOP_SUCCESS";
    fp_stop_result[fp_stop_result["STOP_FAIL"] = 2] = "STOP_FAIL";
    fp_stop_result[fp_stop_result["STOP_IGNORE"] = 3] = "STOP_IGNORE";
})(exports.fp_stop_result || (exports.fp_stop_result = {}));
var fp_stop_result = exports.fp_stop_result;

var fpreader = (function () {
    function fpreader(fpinstance) {
        var _this = this;
        this.close = function () {
            _this.wrapped.close();
        };
        // Start enrolling a fingerprint
        this.start_enroll = function (callback) {
            // tell the fpreader to begin the enroll finger process
            if (!_this.wrapped.enroll_finger(function (result, fpdata, fpimage, height, width) {
                var err = null;

                // If the result was not a successful enrollment
                if (result != 1 /* ENROLL_COMPLETE */) {
                    // store error code in err
                    err = fp_enroll_result[result];
                    callback(err, null, null, null, null, null);
                } else {
                    // check the fpdata for completeness
                    if (fpdata !== null && fpdata !== undefined) {
                        var data = new Buffer(fpdata.length);
                        fpdata.copy(data);
                    }

                    // shouldn't we check these as well? TODO
                    var image = new Buffer(fpimage.length);
                    fpimage.copy(image);

                    // callback to fp_server
                    callback(err, result, data, image, height, width);
                }
            })) {
                // Not finished yet!
                callback("Enroll in progress!", null, null, null, null, null);
            }
        };
        // Stop enrolling a fingerprint
        this.stop_enroll = function (callback) {
            // tell the fp.reader to stop enrollment (if it is enrolling)
            _this.wrapped.stop_enroll_finger(function (result) {
                var err = null;
                if (result == 1 /* STOP_SUCCESS */) {
                    callback(err, true);
                } else {
                    err = fp_stop_result[result];
                    callback(err, null);
                }
            });
        };
        // Start identifying a fingerprint
        this.start_identify = function (callback) {
            // TODO
            callback(null, null);
        };
        // Stop identifying a fingerprint
        this.stop_identify = function (callback) {
            // tell the fp.reader to stop identifying (if it is identifying)
            _this.wrapped.stop_identify_finger();
            callback();
        };
        // Driver for async fingerprint activity
        this.handle_events = function () {
            // tell the fp.reader to handle events, i.e. advance the reader a step
            _this.wrapped.handle_events();
        };
        this.wrapped = fpinstance;

        //these values are static so we can grab them now
        this.enroll_stages = fpinstance.enroll_stages;
        this.supports_imaging = fpinstance.supports_imaging;
        this.supports_identification = fpinstance.supports_identification;
        this.img_width = fpinstance.img_width;
        this.img_height = fpinstance.img_height;
    }
    return fpreader;
})();
exports.fpreader = fpreader;

var fprint = (function () {
    function fprint() {
    }
    // Initializes libfprint and returns 0 if successful.
    fprint.prototype.init = function () {
        return fprintbinding.init();
    };

    fprint.prototype.discover = function () {
        var devices = [];
        fprintbinding.discover(function (handle, devid, drvtype, drvname, drvfullname) {
            var thisdev = {
                handle: handle,
                deviceid: devid,
                driver_type: drvtype,
                driver: drvname,
                driver_detail: drvfullname
            };

            devices.push(thisdev);
        });

        return devices;
    };

    fprint.prototype.get_reader = function (handle) {
        var reader = new fprintbinding.fpreader(handle);
        if (typeof reader != 'undefined') {
            return new fpreader(reader);
        }
        return null;
    };

    fprint.prototype.exit = function () {
        return fprintbinding.exit();
    };
    return fprint;
})();
exports.fprint = fprint;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYmZwcmludC50cyJdLCJuYW1lcyI6WyJmcF9lbnJvbGxfcmVzdWx0IiwiZnBfc3RvcF9yZXN1bHQiLCJmcHJlYWRlciIsImZwcmVhZGVyLmNvbnN0cnVjdG9yIiwiZnByaW50IiwiZnByaW50LmNvbnN0cnVjdG9yIiwiZnByaW50LmluaXQiLCJmcHJpbnQuZGlzY292ZXIiLCJmcHJpbnQuZ2V0X3JlYWRlciIsImZwcmludC5leGl0Il0sIm1hcHBpbmdzIjoiQUFBQSwyQ0FBMkM7QUFBM0MsSUFFSSxNQUFNLEdBQUcsT0FBTyxDQUFDLGNBQWMsQ0FBQztBQUNwQyxJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO0FBQzFCLElBQUksWUFBWSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLGlCQUFpQixDQUFDO0FBQzFELElBQUksWUFBWSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUMxRCxJQUFJLGFBQWEsR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDOztBQUV6QyxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDO0FBQzlCLElBQUksSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7QUFDMUIsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQztBQUM5QixJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDOztBQUU5QixJQUFJLEdBQUc7O0NBRVAsVUFBWSxnQkFBZ0I7SUFFeEJBLHVEQUFrQkEsQ0FBQ0EscUJBQUFBO0lBQ25CQSxtREFBY0EsQ0FBQ0EsaUJBQUFBO0lBQ2ZBLG1EQUFjQSxDQUFDQSxpQkFBQUE7SUFDZkEsb0RBQWVBLEdBQUdBLGtCQUFBQTtJQUNsQkEsOERBQXlCQSxHQUFHQSw0QkFBQUE7SUFDNUJBLGtFQUE2QkEsR0FBR0EsZ0NBQUFBO0lBQ2hDQSxrRUFBNkJBLEdBQUdBLGdDQUFBQTtJQUNoQ0Es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RUEsV0FBV0E7WUFFakVBLElBQUlBLE9BQU9BLEdBQUdBO2dCQUNWQSxNQUFNQSxFQUFFQSxNQUFNQTtnQkFDZEEsUUFBUUEsRUFBRUEsS0FBS0E7Z0JBQ2ZBLFdBQVdBLEVBQUVBLE9BQU9BO2dCQUNwQkEsTUFBTUEsRUFBRUEsT0FBT0E7Z0JBQ2ZBLGFBQWFBLEVBQUVBLFdBQVdBO2FBQzdCQTs7WUFFREEsT0FBT0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0E7UUFDekJBLENBQUNBLENBQUNBOztRQUVWQSxPQUFPQSxPQUFPQTtJQUNsQkEsQ0FBQ0E7O0lBRURILDhCQUFBQSxVQUFXQSxNQUFjQTtRQUNyQkksSUFBSUEsTUFBTUEsR0FBR0EsSUFBSUEsYUFBYUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsTUFBTUEsQ0FBQ0E7UUFDL0NBLElBQUlBLE9BQU9BLE1BQU1BLElBQUlBLFdBQVdBLENBQ2hDQTtZQUNJQSxPQUFPQSxJQUFJQSxRQUFRQSxDQUFDQSxNQUFNQSxDQUFDQTtTQUM5QkE7UUFDREEsT0FBT0EsSUFBSUE7SUFDZkEsQ0FBQ0E7O0lBRURKLHdCQUFBQTtRQUNJSyxPQUFPQSxhQUFhQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtJQUMvQkEsQ0FBQ0E7SUFHTEwsY0FBQ0E7QUFBREEsQ0FBQ0EsSUFBQTtBQXZDRCx3QkF1Q0M7QUFDRCIsImZpbGUiOiJsaWJmcHJpbnQuanMiLCJzb3VyY2VSb290IjoiL2hvbWUvYWVyby9ub2RlLWxpYmZwcmludC8iLCJzb3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSBwYXRoPVwiLi4vdHlwaW5ncy90c2QuZC50c1wiLz5cblxudmFyIGJpbmFyeSA9IHJlcXVpcmUoJ25vZGUtcHJlLWd5cCcpO1xudmFyIHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG52YXIgUEFDS0FHRV9KU09OID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL3BhY2thZ2UuanNvbicpO1xudmFyIGJpbmRpbmdfcGF0aCA9IGJpbmFyeS5maW5kKHBhdGgucmVzb2x2ZShQQUNLQUdFX0pTT04pKTtcbnZhciBmcHJpbnRiaW5kaW5nID0gcmVxdWlyZShiaW5kaW5nX3BhdGgpO1xuXG52YXIgc3RyZWFtID0gcmVxdWlyZSgnc3RyZWFtJyk7XG52YXIgdXRpbCA9IHJlcXVpcmUoJ3V0aWwnKTtcbnZhciBidW55YW4gPSByZXF1aXJlKCdidW55YW4nKTtcbnZhciBldmVudHMgPSByZXF1aXJlKCdldmVudHMnKTtcblxudmFyIGxvZztcblxuZXhwb3J0IGVudW0gZnBfZW5yb2xsX3Jlc3VsdFxue1xuICAgIEVOUk9MTF9DT01QTEVURSA9IDEsXG4gICAgRU5ST0xMX0ZBSUwgPSAyLFxuICAgIEVOUk9MTF9QQVNTID0gMyxcbiAgICBFTlJPTExfUkVUUlkgPSAxMDAsXG4gICAgRU5ST0xMX1JFVFJZX1RPT19TSE9SVCA9IDEwMSxcbiAgICBFTlJPTExfUkVUUllfQ0VOVEVSX0ZJTkdFUiA9IDEwMixcbiAgICBFTlJPTExfUkVUUllfUkVNT1ZFX0ZJTkdFUiA9IDEwMyxcbiAgICBFTlJPTExfQ0FOQ0VMTEVEID0gMjAwIC8vIGN1c3RvbVxufVxuXG5leHBvcnQgZW51bSBmcF9zdG9wX3Jlc3VsdFxue1xuICAgIFNUT1BfU1VDQ0VTUyA9IDEsXG4gICAgU1RPUF9GQUlMID0gMixcbiAgICBTVE9QX0lHTk9SRSA9IDNcbn1cblxuZXhwb3J0IGNsYXNzIGZwcmVhZGVyIHtcbiAgICBwcml2YXRlIHdyYXBwZWQ7XG5cbiAgICBlbnJvbGxfc3RhZ2VzIDogbnVtYmVyO1xuICAgIHN1cHBvcnRzX2ltYWdpbmcgOiBib29sZWFuO1xuICAgIHN1cHBvcnRzX2lkZW50aWZpY2F0aW9uOiBib29sZWFuO1xuICAgIGltZ193aWR0aDogbnVtYmVyO1xuICAgIGltZ19oZWlnaHQ6IG51bWJlcjtcblxuICAgIGNsb3NlID0gKCkgPT4ge1xuICAgICAgICB0aGlzLndyYXBwZWQuY2xvc2UoKTtcbiAgICB9XG5cbiAgICAvLyBTdGFydCBlbnJvbGxpbmcgYSBmaW5nZXJwcmludFxuICAgIHN0YXJ0X2Vucm9sbCA9IChjYWxsYmFjayA6IChlcnIsIHJlc3VsdCA6IGZwX2Vucm9sbF9yZXN1bHQsIGZwZGF0YSA6IEJ1ZmZlciwgZnBpbWFnZTogQnVmZmVyLCBoZWlnaHQgOiBOdW1iZXIsIHdpZHRoIDogTnVtYmVyKSA9PiB2b2lkKSA6IHZvaWQgPT4ge1xuICAgIFxuICAgICAgICAvLyB0ZWxsIHRoZSBmcHJlYWRlciB0byBiZWdpbiB0aGUgZW5yb2xsIGZpbmdlciBwcm9jZXNzXG4gICAgICAgIGlmICghdGhpcy53cmFwcGVkLmVucm9sbF9maW5nZXIoXG4gICAgICAgICAgICAgICAgLy8gRW5yb2xsIGZpbmdlciBoYXMgY29tcGxldGVkXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gKHJlc3VsdDogZnBfZW5yb2xsX3Jlc3VsdCwgZnBkYXRhLCBmcGltYWdlLCBoZWlnaHQgOiBudW1iZXIsIHdpZHRoOiBudW1iZXIpXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICB2YXIgZXJyID0gbnVsbDtcblxuICAgICAgICAgICAgICAgICAgICAvLyBJZiB0aGUgcmVzdWx0IHdhcyBub3QgYSBzdWNjZXNzZnVsIGVucm9sbG1lbnRcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdCAhPSBmcF9lbnJvbGxfcmVzdWx0LkVOUk9MTF9DT01QTEVURSlcbiAgICAgICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gc3RvcmUgZXJyb3IgY29kZSBpbiBlcnJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVyciA9IGZwX2Vucm9sbF9yZXN1bHRbcmVzdWx0XTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVycixudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIFxuICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBjaGVjayB0aGUgZnBkYXRhIGZvciBjb21wbGV0ZW5lc3NcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmcGRhdGEgIT09IG51bGwgJiYgZnBkYXRhICE9PSB1bmRlZmluZWQpXG4gICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRhdGEgPSBuZXcgQnVmZmVyKGZwZGF0YS5sZW5ndGgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZwZGF0YS5jb3B5KGRhdGEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBzaG91bGRuJ3Qgd2UgY2hlY2sgdGhlc2UgYXMgd2VsbD8gVE9ET1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGltYWdlID0gbmV3IEJ1ZmZlcihmcGltYWdlLmxlbmd0aCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBmcGltYWdlLmNvcHkoaW1hZ2UpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBjYWxsYmFjayB0byBmcF9zZXJ2ZXJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKGVyciwgcmVzdWx0LCBkYXRhLCBpbWFnZSwgaGVpZ2h0LCB3aWR0aCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICkpIHtcbiAgICAgICAgICAgIC8vIE5vdCBmaW5pc2hlZCB5ZXQhXG4gICAgICAgICAgICBjYWxsYmFjayhcIkVucm9sbCBpbiBwcm9ncmVzcyFcIiwgbnVsbCwgbnVsbCwgbnVsbCwgbnVsbCwgbnVsbCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBTdG9wIGVucm9sbGluZyBhIGZpbmdlcnByaW50XG4gICAgc3RvcF9lbnJvbGwgPSAoY2FsbGJhY2sgOiAoZXJyLHJlc3VsdCkgPT4gdm9pZCkgOiB2b2lkID0+IHtcbiAgICAgICAgLy8gdGVsbCB0aGUgZnAucmVhZGVyIHRvIHN0b3AgZW5yb2xsbWVudCAoaWYgaXQgaXMgZW5yb2xsaW5nKVxuICAgICAgICB0aGlzLndyYXBwZWQuc3RvcF9lbnJvbGxfZmluZ2VyKFxuICAgICAgICAgICAgZnVuY3Rpb24gKHJlc3VsdDogZnBfc3RvcF9yZXN1bHQpXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgdmFyIGVyciA9IG51bGw7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdCA9PSBmcF9zdG9wX3Jlc3VsdC5TVE9QX1NVQ0NFU1MpIHtcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZXJyLCB0cnVlKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBlcnIgPSBmcF9zdG9wX3Jlc3VsdFtyZXN1bHRdO1xuICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhlcnIsIG51bGwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBTdGFydCBpZGVudGlmeWluZyBhIGZpbmdlcnByaW50XG4gICAgc3RhcnRfaWRlbnRpZnkgPSAoY2FsbGJhY2sgOiAoZXJyLCBzdWNjZXNzKSA9PiB2b2lkKSA6IHZvaWQgPT4ge1xuICAgICAgICAvLyBUT0RPXG4gICAgICAgIGNhbGxiYWNrKG51bGwsbnVsbCk7XG4gICAgfVxuXG4gICAgLy8gU3RvcCBpZGVudGlmeWluZyBhIGZpbmdlcnByaW50XG4gICAgc3RvcF9pZGVudGlmeSA9IChjYWxsYmFjayA6ICgpID0+IHZvaWQpIDogdm9pZCA9PiB7XG4gICAgICAgIC8vIHRlbGwgdGhlIGZwLnJlYWRlciB0byBzdG9wIGlkZW50aWZ5aW5nIChpZiBpdCBpcyBpZGVudGlmeWluZylcbiAgICAgICAgdGhpcy53cmFwcGVkLnN0b3BfaWRlbnRpZnlfZmluZ2VyKCk7XG4gICAgICAgIGNhbGxiYWNrKCk7XG4gICAgfVxuXG4gICAgLy8gRHJpdmVyIGZvciBhc3luYyBmaW5nZXJwcmludCBhY3Rpdml0eVxuICAgIGhhbmRsZV9ldmVudHMgPSAoKSA6IHZvaWQgPT4ge1xuICAgICAgICAvLyB0ZWxsIHRoZSBmcC5yZWFkZXIgdG8gaGFuZGxlIGV2ZW50cywgaS5lLiBhZHZhbmNlIHRoZSByZWFkZXIgYSBzdGVwXG4gICAgICAgIHRoaXMud3JhcHBlZC5oYW5kbGVfZXZlbnRzKCk7XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IoZnBpbnN0YW5jZSkge1xuICAgICAgICB0aGlzLndyYXBwZWQgPSBmcGluc3RhbmNlO1xuXG4gICAgICAgIC8vdGhlc2UgdmFsdWVzIGFyZSBzdGF0aWMgc28gd2UgY2FuIGdyYWIgdGhlbSBub3dcbiAgICAgICAgdGhpcy5lbnJvbGxfc3RhZ2VzID0gZnBpbnN0YW5jZS5lbnJvbGxfc3RhZ2VzO1xuICAgICAgICB0aGlzLnN1cHBvcnRzX2ltYWdpbmcgPSBmcGluc3RhbmNlLnN1cHBvcnRzX2ltYWdpbmc7XG4gICAgICAgIHRoaXMuc3VwcG9ydHNfaWRlbnRpZmljYXRpb24gPSBmcGluc3RhbmNlLnN1cHBvcnRzX2lkZW50aWZpY2F0aW9uO1xuICAgICAgICB0aGlzLmltZ193aWR0aCA9IGZwaW5zdGFuY2UuaW1nX3dpZHRoO1xuICAgICAgICB0aGlzLmltZ19oZWlnaHQgPSBmcGluc3RhbmNlLmltZ19oZWlnaHQ7XG4gICAgfVxufVxuXG5leHBvcnQgY2xhc3MgZnByaW50IHtcblxuICAgIC8vIEluaXRpYWxpemVzIGxpYmZwcmludCBhbmQgcmV0dXJucyAwIGlmIHN1Y2Nlc3NmdWwuXG4gICAgaW5pdCgpIDogbnVtYmVyICB7XG4gICAgICAgIHJldHVybiBmcHJpbnRiaW5kaW5nLmluaXQoKTtcbiAgICB9XG5cbiAgICBkaXNjb3ZlcigpIHtcbiAgICAgICAgdmFyIGRldmljZXMgPSBbXTtcbiAgICAgICAgZnByaW50YmluZGluZy5kaXNjb3ZlciggZnVuY3Rpb24oaGFuZGxlLCBkZXZpZCwgZHJ2dHlwZSwgZHJ2bmFtZSwgZHJ2ZnVsbG5hbWUpXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICB2YXIgdGhpc2RldiA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZTogaGFuZGxlLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGV2aWNlaWQ6IGRldmlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgZHJpdmVyX3R5cGU6IGRydnR5cGUsXG4gICAgICAgICAgICAgICAgICAgICAgICBkcml2ZXI6IGRydm5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICBkcml2ZXJfZGV0YWlsOiBkcnZmdWxsbmFtZVxuICAgICAgICAgICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICAgICAgICAgIGRldmljZXMucHVzaCh0aGlzZGV2KTtcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gZGV2aWNlcztcbiAgICB9XG5cbiAgICBnZXRfcmVhZGVyKGhhbmRsZTogbnVtYmVyKSB7XG4gICAgICAgIHZhciByZWFkZXIgPSBuZXcgZnByaW50YmluZGluZy5mcHJlYWRlcihoYW5kbGUpO1xuICAgICAgICBpZiAodHlwZW9mIHJlYWRlciAhPSAndW5kZWZpbmVkJylcbiAgICAgICAge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBmcHJlYWRlcihyZWFkZXIpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGV4aXQoKSA6IHZvaWQge1xuICAgICAgICByZXR1cm4gZnByaW50YmluZGluZy5leGl0KCk7XG4gICAgfVxuXG4gICAgY29uc3RydWN0b3IgKCkgeyB9XG59XG4iXX0=